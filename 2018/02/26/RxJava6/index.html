<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="RxJava," />





  <link rel="alternate" href="/atom.xml" title="CODE FRAMER BIGZ" type="application/atom+xml" />






<meta name="description" content="理解 RxJava2 中的被压策略">
<meta name="keywords" content="RxJava">
<meta property="og:type" content="article">
<meta property="og:title" content="只因为在众多框架中多看了你一眼 RxJava （六） 背压策略">
<meta property="og:url" content="http://zengfanyu.top/2018/02/26/RxJava6/index.html">
<meta property="og:site_name" content="CODE FRAMER BIGZ">
<meta property="og:description" content="理解 RxJava2 中的被压策略">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.imgur.com/cCjinS0.png">
<meta property="og:image" content="https://i.imgur.com/yn6AlrP.png">
<meta property="og:image" content="https://i.imgur.com/8wquKHV.png">
<meta property="og:image" content="https://i.imgur.com/rSYpGnt.png">
<meta property="og:image" content="https://i.imgur.com/eMjKDXS.gif">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/944365-233a841e920c83e0.png">
<meta property="og:image" content="https://i.imgur.com/hqRoGqL.png">
<meta property="og:image" content="https://i.imgur.com/JvBotn1.png">
<meta property="og:image" content="https://i.imgur.com/dLRroTM.png">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/944365-45e520e7016cf9fd.png">
<meta property="og:image" content="https://i.imgur.com/FXUoosP.png">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/944365-f6314aba60c08455.png">
<meta property="og:image" content="https://i.imgur.com/r5N7sQz.gif">
<meta property="og:image" content="https://i.imgur.com/Sy9jncs.gif">
<meta property="og:image" content="https://i.imgur.com/DFeA1hJ.gif">
<meta property="og:image" content="http://reactivex.io/documentation/operators/images/interval.c.png">
<meta property="og:image" content="https://i.imgur.com/5DNSzwe.gif">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/944365-1be234a3c566c7bc.png">
<meta property="og:updated_time" content="2018-02-28T13:57:25.190Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="只因为在众多框架中多看了你一眼 RxJava （六） 背压策略">
<meta name="twitter:description" content="理解 RxJava2 中的被压策略">
<meta name="twitter:image" content="https://i.imgur.com/cCjinS0.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://zengfanyu.top/2018/02/26/RxJava6/"/>





  <title>只因为在众多框架中多看了你一眼 RxJava （六） 背压策略 | CODE FRAMER BIGZ</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">CODE FRAMER BIGZ</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Every little makes a mickel</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-server"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zengfanyu.top/2018/02/26/RxJava6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="BIGZ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar_z.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CODE FRAMER BIGZ">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">只因为在众多框架中多看了你一眼 RxJava （六） 背压策略</h1>
        

        <div class="post-meta">
          <span class="post-time">

           
             <span class="post-letters-count">
              &nbsp; | &nbsp;
           <span>7,883 字</span>
               &nbsp; | &nbsp;
           <span>38 min</span>
            </span>
           

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-26T14:16:16+08:00">
                2018-02-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/02/26/RxJava6/" class="leancloud_visitors" data-flag-title="只因为在众多框架中多看了你一眼 RxJava （六） 背压策略">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="https://i.imgur.com/cCjinS0.png" alt=""></p>
<p>理解 RxJava2 中的被压策略</p>
<a id="more"></a>
<font face="黑体">

<blockquote>
<p>文中措辞 被观察者 &lt;=&gt; 上游； 观察者 &lt;=&gt; 下游 是等价的。</p>
</blockquote>
<h1 id="宏观上解决流速不匹配的问题"><a href="#宏观上解决流速不匹配的问题" class="headerlink" title="宏观上解决流速不匹配的问题"></a>宏观上解决流速不匹配的问题</h1><p>通过上一篇，我们知道，阻塞是因为上游发送事件的流速和下游接收处理事件的流速不匹配造成的（一般是 上游流速 &gt; 下游流速），那么要解决这个问题，「要么减少上游发送事件的数量」，「要么减少上游发送事件的频率」，但是我们又不能手动实现这一点，因为我们不知道上游道理应该发送多少事件和发送事件的速度，并且也不知道下游处理消耗事件的能力，所以简单的通过控制上游发送事件的数量和速度是不可行的。</p>
<p>那么我们这里抛开代码实现，从宏观上谈一下如何解决这个问题。</p>
<p>要解决阻塞，控制流速，需要上下游协同合作。比如说：下游告诉上游，我可以处理 20 个事件（<strong>响应式拉取</strong>），那么上游就发送 20 个事件（<strong>反馈控制</strong>），当下游处理完了之后，下游又告诉上游，我还可以再处理 30 个事件，那么上游又发送 30 个事件过来，我们知道，异步订阅，上游发送的事件是放在一个 缓存池 中的， 而下游直接从缓存池中去取，那么如果上游发送的事件个数大于下游的处理个数，缓存池就会有溢出的风险，所以在这里也得有一个方法来解决。</p>
<p>这种方法就类似于 Universal Image Loader 中提供的各种缓存策略，内存缓存的大小有限，所以用内存做缓存时要处理好当接近内存大小临界值时，如何丢弃现有的缓存，存入新的缓存？是最近最少使用的丢弃？还是暂用空间最小的丢弃？还是最先缓存的丢弃？这里就涉及到各种策略。RxJava2.0 中也提供了好几种策略，后面详细说。</p>
<p>通过上面描述的方案，就可以有效的解决上下游流速不匹配导致的阻塞问题。</p>
<p>总的来说： </p>
<ol>
<li>要尽量避免出现流速不匹配。</li>
<li>当已经出现流速不匹配了，应该采取策略。</li>
</ol>
<p>下面谈谈 RxJava2 中的背压策略。</p>
<h1 id="背压策略"><a href="#背压策略" class="headerlink" title="背压策略"></a>背压策略</h1><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>一种控制事件流速的方法。</p>
<h2 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h2><p>在 <strong><font color="#ff0000">异步事件订阅</font></strong> 中，控制事件发送的速度和接收的速度。</p>
<h2 id="解决的问题"><a href="#解决的问题" class="headerlink" title="解决的问题"></a>解决的问题</h2><p>解决了 <strong><font color="#ff0000">异步订阅中</font></strong> 因被观察者发送事件速度 与 观察者接收事件速度不匹配（一般是前者 快于 后者），从而导致观察者无法及时响应 / 处理所有被观察者发送事件的问题</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><img src="https://i.imgur.com/yn6AlrP.png" alt=""></p>
<p>示意图：</p>
<p><img src="https://i.imgur.com/8wquKHV.png" alt=""></p>
<p>与 Rxjava1 中被观察者的旧实现 Observable 相比：</p>
<p><img src="https://i.imgur.com/rSYpGnt.png" alt=""></p>
<p>图中出现了一个新的类， Flowable ，它就是 RxJava2.0 中被观察者的一种新的实现，同时也是背压策略的承载者，下面就来看看如何使用它。</p>
<h1 id="背压策略的实现：Flowable"><a href="#背压策略的实现：Flowable" class="headerlink" title="背压策略的实现：Flowable"></a>背压策略的实现：Flowable</h1><h2 id="Flowable-基本使用"><a href="#Flowable-基本使用" class="headerlink" title="Flowable 基本使用"></a>Flowable 基本使用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Flowable <span class="comment">//Observable --&gt; Flowable</span></div><div class="line">        .create(<span class="keyword">new</span> FlowableOnSubscribe&lt;Integer&gt;() &#123; <span class="comment">//1.ObservableOnSubscribe -&gt; FlowableOnSubscribe</span></div><div class="line">            <span class="meta">@Override</span>  <span class="comment">//2.ObservableEmitter -&gt; FlowableEmitter</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(FlowableEmitter&lt;Integer&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123; </div><div class="line">                LogUtil.d(TAG, <span class="string">"emitter 1"</span>);</div><div class="line">                e.onNext(<span class="number">1</span>);</div><div class="line">                LogUtil.d(TAG, <span class="string">"emitter 2"</span>);</div><div class="line">                e.onNext(<span class="number">2</span>);</div><div class="line">                LogUtil.d(TAG, <span class="string">"emitter 3"</span>);</div><div class="line">                e.onNext(<span class="number">3</span>);</div><div class="line">                LogUtil.d(TAG, <span class="string">"emitter complete"</span>);</div><div class="line">                e.onComplete();</div><div class="line">            &#125;</div><div class="line">        &#125;, BackpressureStrategy.ERROR) <span class="comment">//3.背压策略</span></div><div class="line">        .subscribe(<span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span> <span class="comment">//4.onSubscribe(Disposable d) -&gt; onSubscribe(Subscription s)</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onSubscribe"</span>);</div><div class="line">                s.request(Long.MAX_VALUE);<span class="comment">//5. 向上游请求的元素，响应式拉取</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onNext integer="</span> + integer);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                LogUtil.w(TAG, t);</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onComplete"</span>);</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>日志：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">09</span>:<span class="number">11.591</span> <span class="number">22450</span>-<span class="number">22450</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onSubscribe</div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">09</span>:<span class="number">11.591</span> <span class="number">22450</span>-<span class="number">22450</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== emitter <span class="number">1</span></div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">09</span>:<span class="number">11.591</span> <span class="number">22450</span>-<span class="number">22450</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=<span class="number">1</span></div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">09</span>:<span class="number">11.591</span> <span class="number">22450</span>-<span class="number">22450</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== emitter <span class="number">2</span></div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">09</span>:<span class="number">11.591</span> <span class="number">22450</span>-<span class="number">22450</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=<span class="number">2</span></div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">09</span>:<span class="number">11.591</span> <span class="number">22450</span>-<span class="number">22450</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== emitter <span class="number">3</span></div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">09</span>:<span class="number">11.592</span> <span class="number">22450</span>-<span class="number">22450</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=<span class="number">3</span></div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">09</span>:<span class="number">11.592</span> <span class="number">22450</span>-<span class="number">22450</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== emitter complete</div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">09</span>:<span class="number">11.592</span> <span class="number">22450</span>-<span class="number">22450</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onComplete</div></pre></td></tr></table></figure>
<p>代码中已经注释出了 Flowable 相对于 Observable 使用的不同之处，这里总结一下</p>
<ol>
<li>ObservableOnSubscribe -&gt; FlowableOnSubscribe</li>
<li>ObservableEmitter -&gt; FlowableEmitter</li>
<li>背压策略</li>
<li>onSubscribe(Disposable d) -&gt; onSubscribe(Subscription s)</li>
<li>s.request(Long.MAX_VALUE);// 向被观察者请求的元素，响应式拉取</li>
</ol>
<p>下面针对这几点不同做讲解。</p>
<h2 id="Subscription-request-控制观察者的接收速度"><a href="#Subscription-request-控制观察者的接收速度" class="headerlink" title="Subscription.request 控制观察者的接收速度"></a>Subscription.request 控制观察者的接收速度</h2><p>我们从 request 方法开始看看 Flowable 的使用。</p>
<p>现在将19行的 s.request(Long.MAX_VALUE) 删掉，在看日志</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">53.949</span> <span class="number">22450</span>-<span class="number">22450</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onSubscribe</div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">53.949</span> <span class="number">22450</span>-<span class="number">22450</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== emitter <span class="number">1</span></div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">53.950</span> <span class="number">22450</span>-<span class="number">22450</span>/com.rengwuxian.rxjavasamples W/===RxJavaSample==: io.reactivex.exceptions.MissingBackpressureException: create: could not emit value due to lack of requests</div><div class="line">                         at io.reactivex.internal.operators.flowable.FlowableCreate$ErrorAsyncEmitter.onOverflow(FlowableCreate.java:<span class="number">411</span>)</div><div class="line">                         at io.reactivex.internal.operators.flowable.FlowableCreate$NoOverflowBaseAsyncEmitter.onNext(FlowableCreate.java:<span class="number">377</span>)</div><div class="line">                         at com.rengwuxian.rxjavasamples.Test$<span class="number">2</span>$override.subscribe(Test.java:<span class="number">91</span>)</div><div class="line">                         at com.rengwuxian.rxjavasamples.Test$<span class="number">2</span>$override.access$dispatch(Test.java)</div><div class="line">                         at com.rengwuxian.rxjavasamples.Test$<span class="number">2</span>.subscribe(Test.java:<span class="number">0</span>)</div><div class="line">                         at io.reactivex.internal.operators.flowable.FlowableCreate.subscribeActual(FlowableCreate.java:<span class="number">72</span>)</div><div class="line">                         at io.reactivex.Flowable.subscribe(Flowable.java:<span class="number">12970</span>)</div><div class="line">                         at io.reactivex.Flowable.subscribe(Flowable.java:<span class="number">12920</span>)</div><div class="line">                         at com.rengwuxian.rxjavasamples.Test$override.onClick(Test.java:<span class="number">100</span>)</div><div class="line">                         at com.rengwuxian.rxjavasamples.Test$override.access$dispatch(Test.java)</div><div class="line">                         at com.rengwuxian.rxjavasamples.Test.onClick(Test.java:<span class="number">0</span>)</div><div class="line">                         at com.rengwuxian.rxjavasamples.Test_ViewBinding$<span class="number">1</span>.doClick(Test_ViewBinding.java:<span class="number">37</span>)</div><div class="line">                         at butterknife.internal.DebouncingOnClickListener.onClick(DebouncingOnClickListener.java:<span class="number">22</span>)</div><div class="line">                         at android.view.View.performClick(View.java:<span class="number">5619</span>)</div><div class="line">                         at android.view.View$PerformClick.run(View.java:<span class="number">22295</span>)</div><div class="line">                         at android.os.Handler.handleCallback(Handler.java:<span class="number">754</span>)</div><div class="line">                         at android.os.Handler.dispatchMessage(Handler.java:<span class="number">95</span>)</div><div class="line">                         at android.os.Looper.loop(Looper.java:<span class="number">163</span>)</div><div class="line">                         at android.app.ActivityThread.main(ActivityThread.java:<span class="number">6342</span>)</div><div class="line">                         at java.lang.reflect.Method.invoke(Native Method)</div><div class="line">                         at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:<span class="number">880</span>)</div><div class="line">                         at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">770</span>)</div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">53.950</span> <span class="number">22450</span>-<span class="number">22450</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== emitter <span class="number">2</span></div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">53.950</span> <span class="number">22450</span>-<span class="number">22450</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== emitter <span class="number">3</span></div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">53.950</span> <span class="number">22450</span>-<span class="number">22450</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== emitter complete</div></pre></td></tr></table></figure>
<p>在上游发送了第一个事件之后，下游就抛出了 MissingBackpressureException 异常，但是根据上一篇的内容，这里是同步订阅关系，上游要等下游处理完事件之后才回去发送下一个事件，所以应该不会阻塞，所以这里不应该会抛出异常啊！但事实还是抛出了异常，为什么呢？带着这个疑问，我们仍然将 19 行 s.request(Long.MAX_VALUE) 删掉并且将上下游放到不同的线程中再看看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Flowable <span class="comment">//Observable --&gt; Flowable</span></div><div class="line">            .create(<span class="keyword">new</span> FlowableOnSubscribe&lt;Integer&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(FlowableEmitter&lt;Integer&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                    LogUtil.d(TAG, <span class="string">"emitter 1"</span>);</div><div class="line">                    e.onNext(<span class="number">1</span>);</div><div class="line">                    LogUtil.d(TAG, <span class="string">"emitter 2"</span>);</div><div class="line">                    e.onNext(<span class="number">2</span>);</div><div class="line">                    LogUtil.d(TAG, <span class="string">"emitter 3"</span>);</div><div class="line">                    e.onNext(<span class="number">3</span>);</div><div class="line">                    LogUtil.d(TAG, <span class="string">"emitter complete"</span>);</div><div class="line">                    e.onComplete();</div><div class="line">                &#125;</div><div class="line">            &#125;, BackpressureStrategy.ERROR) <span class="comment">//策略</span></div><div class="line">            .subscribeOn(Schedulers.io())<span class="comment">//上游io线程</span></div><div class="line">            .observeOn(AndroidSchedulers.mainThread())<span class="comment">//下游主线程</span></div><div class="line">            .subscribe(<span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</div><div class="line">                    LogUtil.d(TAG, <span class="string">"onSubscribe"</span>);</div><div class="line">            </div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                    LogUtil.d(TAG, <span class="string">"onNext integer="</span> + integer);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                    LogUtil.w(TAG, t);</div><div class="line"></div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">                    LogUtil.d(TAG, <span class="string">"onComplete"</span>);</div><div class="line"></div><div class="line">                &#125;</div><div class="line">            &#125;);</div></pre></td></tr></table></figure>
<p>日志：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">13</span>:<span class="number">13.942</span> <span class="number">22450</span>-<span class="number">22450</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onSubscribe</div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">13</span>:<span class="number">13.943</span> <span class="number">22450</span>-<span class="number">29562</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== emitter <span class="number">1</span></div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">13</span>:<span class="number">13.944</span> <span class="number">22450</span>-<span class="number">29562</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== emitter <span class="number">2</span></div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">13</span>:<span class="number">13.944</span> <span class="number">22450</span>-<span class="number">29562</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== emitter <span class="number">3</span></div><div class="line"><span class="number">02</span>-<span class="number">25</span> <span class="number">10</span>:<span class="number">13</span>:<span class="number">13.944</span> <span class="number">22450</span>-<span class="number">29562</span>/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== emitter complete</div></pre></td></tr></table></figure>
<p>只能看到上游发送的事件，但是下游并没有获取到事件，这又是为什么？</p>
<p>这是因为 Flowable 采用的是一种响应式拉取的方式，上游需要根据下游的能力去发送事件。<br>而<strong>第 19 行的 s.request(Long.MAX_VALUE) 就相当于下游告知上游其本身的接收能力</strong>。</p>
<p>那么现在就可以解释上面代码的现象了。</p>
<ul>
<li><p>当同步的订阅时，上游发送出一个事件后就抛出 MissingBackpressureException 异常，这是因为下游没有调用 request 方法，也就是说下游没有告知上游其处理事件的能力，那么上游就认为下游没有处理事件的能力，又因为是同步的，上游是需要等待下游处理完事件之后才发送下一个事件，现在下游没有处理事件的能力，那上游不能一直等着吧？所以就抛出异常咯。</p>
</li>
<li><p>当异步订阅的时候，会存在一个缓存池，上游发送的事件都放到这个缓存池里面去了，然后下游根据其能力 （request 方法的参数） 从缓存池里取出事件。然而此时并没有调用 request 方法，所以我们只看得到上游发送事件的日志，看不到下游响应事件的日志。但是一旦下游调用 request 时，就会从缓存池中去取出事件，是不是这样呢? 看代码</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@OnClick</span>(&#123;R.id.id_btn_request, R.id.id_btn_emitter&#125;)</div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (view.getId() == R.id.id_btn_emitter) &#123;</div><div class="line">           LogUtil.d(TAG,<span class="string">"emitter event"</span>);</div><div class="line">           Flowable <span class="comment">//Observable --&gt; Flowable</span></div><div class="line">                   .create(<span class="keyword">new</span> FlowableOnSubscribe&lt;Integer&gt;() &#123;</div><div class="line">                       <span class="meta">@Override</span></div><div class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(FlowableEmitter&lt;Integer&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                           LogUtil.d(TAG, <span class="string">"emitter 1"</span>);</div><div class="line">                           e.onNext(<span class="number">1</span>);</div><div class="line">                           LogUtil.d(TAG, <span class="string">"emitter 2"</span>);</div><div class="line">                           e.onNext(<span class="number">2</span>);</div><div class="line">                           LogUtil.d(TAG, <span class="string">"emitter 3"</span>);</div><div class="line">                           e.onNext(<span class="number">3</span>);</div><div class="line">                           LogUtil.d(TAG, <span class="string">"emitter complete"</span>);</div><div class="line">                           e.onComplete();</div><div class="line">	</div><div class="line">                       &#125;</div><div class="line">                   &#125;, BackpressureStrategy.ERROR) <span class="comment">//策略</span></div><div class="line">                   .subscribeOn(Schedulers.io())</div><div class="line">                   .observeOn(AndroidSchedulers.mainThread())</div><div class="line">                   .subscribe(<span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</div><div class="line">                       <span class="meta">@Override</span></div><div class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</div><div class="line">                           LogUtil.d(TAG, <span class="string">"onSubscribe"</span>);</div><div class="line">                           mSubscription=s;</div><div class="line">                       &#125;</div><div class="line">	</div><div class="line">                       <span class="meta">@Override</span></div><div class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                           LogUtil.d(TAG, <span class="string">"onNext integer="</span> + integer);</div><div class="line">                       &#125;</div><div class="line">	</div><div class="line">                       <span class="meta">@Override</span></div><div class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                           LogUtil.w(TAG, t);</div><div class="line">	</div><div class="line">                       &#125;</div><div class="line">	</div><div class="line">                       <span class="meta">@Override</span></div><div class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">                           LogUtil.d(TAG, <span class="string">"onComplete"</span>);</div><div class="line">	</div><div class="line">                       &#125;</div><div class="line">                   &#125;);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (view.getId() == R.id.id_btn_request) &#123;</div><div class="line">           <span class="keyword">if</span> (mSubscription != <span class="keyword">null</span>) &#123;</div><div class="line">               LogUtil.d(TAG,<span class="string">"request invoked"</span>);</div><div class="line">               mSubscription.request(<span class="number">1</span>);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               LogUtil.d(TAG, <span class="string">"mSubscription is null"</span>);</div><div class="line">           &#125;</div><div class="line">	</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>可以看到，这里我们设置了两个按钮，当点击 btnEmitter 时会发送事件，并且在 onSubscribe 回调中将 Subscription 保存起来，然后当点击 btnRequest 按钮时，会调用 mSubscription.request(1)。这里我们点击 btnEmitter 一下，然后点击 btnRequest 3 下，看看日志：</p>
<p><img src="https://i.imgur.com/eMjKDXS.gif" alt=""></p>
<p>ok，验证了，确实是这样。</p>
<blockquote>
<p>之前我们说到，上游会将事件发送到缓存池里，然后下游根据其能力从缓存池中取出事件，那么这个缓存池有多大呢？ <strong>128</strong> ！从上游发送 128 个事件和 129 个事件，分别观察日志即可证明，这里就不在写出代码。</p>
</blockquote>
<p>到这里，下游已经可以通过 request 控制处理事件的能力了，但是上游还得获取这一信息呀，上游根据这一信息来控制其本身发送事件的速度，怎么获取呢？</p>
<h2 id="FlowableEmitter-requested-控制被观察者发送事件的速度"><a href="#FlowableEmitter-requested-控制被观察者发送事件的速度" class="headerlink" title="FlowableEmitter.requested 控制被观察者发送事件的速度"></a>FlowableEmitter.requested 控制被观察者发送事件的速度</h2><p>FlowableEmitter 的 requested 方法的返回值就是<strong><font color="#ff000000">当前线程</font></strong>中，下游 subscription 的 request(n) 的 n 值，那么很显然，这里就分为同步订阅关系和异步订阅关系。</p>
<h3 id="同步订阅情况下"><a href="#同步订阅情况下" class="headerlink" title="同步订阅情况下"></a>同步订阅情况下</h3><p><img src="https://upload-images.jianshu.io/upload_images/944365-233a841e920c83e0.png" alt="image"></p>
<p>看代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Flowable.create(<span class="keyword">new</span> FlowableOnSubscribe&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(FlowableEmitter&lt;Integer&gt; emitter)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">                <span class="comment">// 调用emitter.requested()获取当前观察者需要接收的事件数量</span></div><div class="line">                <span class="keyword">long</span> n = emitter.requested();</div><div class="line"></div><div class="line">                Log.d(TAG, <span class="string">"观察者可接收事件"</span> + n);</div><div class="line"></div><div class="line">                <span class="comment">// 根据emitter.requested()的值，即当前观察者需要接收的事件数量来发送事件</span></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">                    Log.d(TAG, <span class="string">"发送了事件"</span> + i);</div><div class="line">                    emitter.onNext(i);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;, BackpressureStrategy.ERROR)</div><div class="line">                .subscribe(<span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</div><div class="line">                        Log.d(TAG, <span class="string">"onSubscribe"</span>);</div><div class="line"></div><div class="line">                        <span class="comment">// 设置观察者每次能接受10个事件</span></div><div class="line">                        s.request(<span class="number">10</span>);</div><div class="line"></div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                        Log.d(TAG, <span class="string">"接收到了事件"</span> + integer);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                        Log.w(TAG, <span class="string">"onError: "</span>, t);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">                        Log.d(TAG, <span class="string">"onComplete"</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure>
<p>日志：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.844</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: onSubscribe</div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.845</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 观察者可接收事件<span class="number">10</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.845</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件<span class="number">0</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.845</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 接收到了事件<span class="number">0</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.845</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件<span class="number">1</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.846</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 接收到了事件<span class="number">1</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.846</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件<span class="number">2</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.846</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 接收到了事件<span class="number">2</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.846</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件<span class="number">3</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.846</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 接收到了事件<span class="number">3</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.846</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件<span class="number">4</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.846</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 接收到了事件<span class="number">4</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.846</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件<span class="number">5</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.846</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 接收到了事件<span class="number">5</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.846</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件<span class="number">6</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.846</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 接收到了事件<span class="number">6</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.846</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件<span class="number">7</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.846</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 接收到了事件<span class="number">7</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.846</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件<span class="number">8</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.846</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 接收到了事件<span class="number">8</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.846</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件<span class="number">9</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">10</span>:<span class="number">45</span>:<span class="number">10.846</span> <span class="number">23613</span>-<span class="number">23613</span>/com.rengwuxian.rxjavasamples D/==Test==: 接收到了事件<span class="number">9</span></div></pre></td></tr></table></figure>
<p>并且在<strong>同步订阅</strong>当中使用 requested 时，有三个特性需要注意。</p>
<p><strong>1. 可叠加性：下游可以连续调用 request，上游会进行叠加。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Flowable <span class="comment">//Observable --&gt; Flowable</span></div><div class="line">        .create(<span class="keyword">new</span> FlowableOnSubscribe&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(FlowableEmitter&lt;Integer&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                <span class="keyword">long</span> requested = e.requested();</div><div class="line">                LogUtil.d(TAG, <span class="string">"subscribe requested="</span> + requested);</div><div class="line"></div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;, BackpressureStrategy.ERROR) <span class="comment">//策略</span></div><div class="line">        .subscribe(<span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onSubscribe"</span>);</div><div class="line">                s.request(<span class="number">10</span>);</div><div class="line">                s.request(<span class="number">20</span>);</div><div class="line">                s.request(<span class="number">30</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onNext integer="</span> + integer);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                LogUtil.w(TAG, t);</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onComplete"</span>);</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>日志：</p>
<p><img src="https://i.imgur.com/hqRoGqL.png" alt=""></p>
<p><strong>2. 实时更新性：每次发送事件后，emitter.requested() 会实时更新观察者能接受的事件</strong></p>
<p>仅计算 onNext 事件，onComplete  onError事件不算。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Flowable <span class="comment">//Observable --&gt; Flowable</span></div><div class="line">        .create(<span class="keyword">new</span> FlowableOnSubscribe&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(FlowableEmitter&lt;Integer&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                <span class="keyword">long</span> requested = e.requested();</div><div class="line">                LogUtil.d(TAG, <span class="string">"没有发送事件前， requested="</span> + requested);</div><div class="line"></div><div class="line">                e.onNext(<span class="number">1</span>);</div><div class="line">                requested = e.requested();</div><div class="line">                LogUtil.d(TAG, <span class="string">"发送第一个事件之后， requested="</span> + requested);</div><div class="line"></div><div class="line">                e.onNext(<span class="number">2</span>);</div><div class="line">                requested = e.requested();</div><div class="line">                LogUtil.d(TAG, <span class="string">"发送第二个事件之后， requested="</span> + requested);</div><div class="line"></div><div class="line">                e.onNext(<span class="number">3</span>);</div><div class="line">                requested = e.requested();</div><div class="line">                LogUtil.d(TAG, <span class="string">"发送第三个事件之后， requested="</span> + requested);</div><div class="line"></div><div class="line">                e.onNext(<span class="number">4</span>);</div><div class="line">                requested = e.requested();</div><div class="line">                LogUtil.d(TAG, <span class="string">"发送第四个事件之后， requested="</span> + requested);</div><div class="line"></div><div class="line">                e.onNext(<span class="number">5</span>);</div><div class="line">                requested = e.requested();</div><div class="line">                LogUtil.d(TAG, <span class="string">"发送第五个事件之后， requested="</span> + requested);</div><div class="line"></div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;, BackpressureStrategy.ERROR) <span class="comment">//策略</span></div><div class="line">        .subscribe(<span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onSubscribe"</span>);</div><div class="line">                s.request(<span class="number">10</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onNext integer="</span> + integer);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                LogUtil.w(TAG, t);</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onComplete"</span>);</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>日志：</p>
<p><img src="https://i.imgur.com/JvBotn1.png" alt=""></p>
<p><strong>3. 异常</strong></p>
<p>当 FlowableEmitter.requested() 减到 0 时，则代表观察者已经不可接收事件，此时被观察者若继续发送事件，则会抛出MissingBackpressureException 异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Flowable <span class="comment">//Observable --&gt; Flowable</span></div><div class="line">        .create(<span class="keyword">new</span> FlowableOnSubscribe&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(FlowableEmitter&lt;Integer&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                <span class="keyword">long</span> requested = e.requested();</div><div class="line">                LogUtil.d(TAG, <span class="string">"没有发送事件前， requested="</span> + requested);</div><div class="line"></div><div class="line">                e.onNext(<span class="number">1</span>);</div><div class="line">                requested = e.requested();</div><div class="line">                LogUtil.d(TAG, <span class="string">"发送第一个事件之后， requested="</span> + requested);</div><div class="line"></div><div class="line">                e.onNext(<span class="number">2</span>);</div><div class="line">                requested = e.requested();</div><div class="line">                LogUtil.d(TAG, <span class="string">"发送第二个事件之后， requested="</span> + requested);</div><div class="line"></div><div class="line">                e.onNext(<span class="number">3</span>);</div><div class="line">                requested = e.requested();</div><div class="line">                LogUtil.d(TAG, <span class="string">"发送第三个事件之后， requested="</span> + requested);</div><div class="line"></div><div class="line">                e.onNext(<span class="number">4</span>);</div><div class="line">                requested = e.requested();</div><div class="line">                LogUtil.d(TAG, <span class="string">"发送第四个事件之后， requested="</span> + requested);</div><div class="line"></div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;, BackpressureStrategy.ERROR) <span class="comment">//策略</span></div><div class="line">        .subscribe(<span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onSubscribe"</span>);</div><div class="line">                s.request(<span class="number">3</span>);</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onNext integer="</span> + integer);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                LogUtil.w(TAG, t);</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onComplete"</span>);</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>这里下游只能处理 3 个事件，但是上游却发出了 4 个，那么看看发出第四个事件时，会发生什么情况：</p>
<p><img src="https://i.imgur.com/dLRroTM.png" alt=""></p>
<p>抛出异常。</p>
<p>额外的一点，当下游没有调用 request 方法时，此时上游 requested 的返回值为 0 。</p>
<h3 id="异步订阅情况下"><a href="#异步订阅情况下" class="headerlink" title="异步订阅情况下"></a>异步订阅情况下</h3><p><img src="https://upload-images.jianshu.io/upload_images/944365-45e520e7016cf9fd.png" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Flowable <span class="comment">//Observable --&gt; Flowable</span></div><div class="line">        .create(<span class="keyword">new</span> FlowableOnSubscribe&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(FlowableEmitter&lt;Integer&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                <span class="keyword">long</span> requested = e.requested();</div><div class="line">                LogUtil.d(TAG, <span class="string">"没有发送事件前， requested="</span> + requested);</div><div class="line">            &#125;</div><div class="line">        &#125;, BackpressureStrategy.ERROR) <span class="comment">//策略</span></div><div class="line">        .subscribeOn(Schedulers.io())</div><div class="line">        .observeOn(AndroidSchedulers.mainThread())</div><div class="line">        .subscribe(<span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onSubscribe"</span>);</div><div class="line">                s.request(<span class="number">3</span>);</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onNext integer="</span> + integer);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                LogUtil.w(TAG, t);</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onComplete"</span>);</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>日志：</p>
<p><img src="https://i.imgur.com/FXUoosP.png" alt=""></p>
<p>这里我们可以看到，下游调用 request 表明自己处理事件的能力为 3 ，但是上游 requested 方法返回的值仍然是 128；</p>
<p>所以，<strong>当上下游二者处于不同线程，上游无法通过 FlowableEmitter.requested() 知道下游自身接收事件能力，即 上游不能根据 下游自身接收事件的能力 控制发送事件的速度。</strong></p>
<p><strong><font color="#ff0000">而在异步订阅关系中，反向控制的原理是：通过 RxJava 内部固定调用被观察者线程中的 request(n) 从而 反向控制被观察者的发送事件速度.</font></strong></p>
<p>那么什么时候在 RxJava 内部调用 request(n)，并且 n 等于多少呢？</p>
<p>看下图：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/944365-f6314aba60c08455.png" alt="image"></p>
<p>究竟是不是这样呢，还是要上代码来验证：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Flowable <span class="comment">//Observable --&gt; Flowable</span></div><div class="line">        .create(<span class="keyword">new</span> FlowableOnSubscribe&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(FlowableEmitter&lt;Integer&gt; e)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"观察者可接收事件数量 = "</span> + e.requested());</div><div class="line">                <span class="keyword">boolean</span> flag; <span class="comment">//设置标记位控制</span></div><div class="line"></div><div class="line">                <span class="comment">// 被观察者一共需要发送500个事件</span></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">501</span>; i++) &#123;</div><div class="line">                    flag = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">                    <span class="comment">// 若requested() == 0则不发送</span></div><div class="line">                    <span class="keyword">while</span> (e.requested() == <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">if</span> (!flag) &#123;</div><div class="line">                            Log.d(TAG, <span class="string">"不再发送"</span>);</div><div class="line">                            flag = <span class="keyword">true</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// requested() ≠ 0 才发送</span></div><div class="line">                    e.onNext(i);</div><div class="line">                    Log.d(TAG, <span class="string">"发送了事件"</span> + i + <span class="string">"，观察者可接收事件数量 = "</span> + e.requested());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">        &#125;, BackpressureStrategy.ERROR) <span class="comment">//策略</span></div><div class="line">        .subscribeOn(Schedulers.io())</div><div class="line">        .observeOn(AndroidSchedulers.mainThread())</div><div class="line">        .subscribe(<span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onSubscribe"</span>);</div><div class="line">                mSubscription = s;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onNext integer="</span> + integer);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                LogUtil.w(TAG, t);</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">                LogUtil.d(TAG, <span class="string">"onComplete"</span>);</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line"><span class="meta">@OnClick</span>(R.id.id_btn_request)</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">    mSubscription.request(<span class="number">48</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>程序启动：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">02-25 16:38:53.177 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onSubscribe</div><div class="line">02-25 16:38:53.179 16487-16512/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== 观察者可接收事件数量 = 128</div><div class="line">02-25 16:38:53.180 16487-16512/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件1，观察者可接收事件数量 = 127</div><div class="line">02-25 16:38:53.180 16487-16512/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件2，观察者可接收事件数量 = 126</div><div class="line">02-25 16:38:53.180 16487-16512/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件3，观察者可接收事件数量 = 125</div><div class="line">02-25 16:38:53.180 16487-16512/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件4，观察者可接收事件数量 = 124</div><div class="line">....</div><div class="line">02-25 16:38:53.186 16487-16512/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件126，观察者可接收事件数量 = 2</div><div class="line">02-25 16:38:53.186 16487-16512/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件127，观察者可接收事件数量 = 1</div><div class="line">02-25 16:38:53.186 16487-16512/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件128，观察者可接收事件数量 = 0</div><div class="line">02-25 16:38:53.186 16487-16512/com.rengwuxian.rxjavasamples D/==Test==: 不再发送</div></pre></td></tr></table></figure>
<p>上游发送事件 1~128，下游没有接收任何事件</p>
<ul>
<li>第一次点击按钮调用 request(48):</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">2-25 16:39:04.089 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=1</div><div class="line">02-25 16:39:04.089 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=2</div><div class="line">02-25 16:39:04.089 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=3</div><div class="line">02-25 16:39:04.089 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=4</div><div class="line">02-25 16:39:04.089 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=5</div><div class="line">...</div><div class="line">02-25 16:39:04.091 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=46</div><div class="line">02-25 16:39:04.091 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=47</div><div class="line">02-25 16:39:04.091 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=48</div></pre></td></tr></table></figure>
<p>从缓存池中取出 48 个事件(1~48)，且上游没有重新发送事件，此时下游观察者接收事件 n=48</p>
<ul>
<li>第二次点击按钮调用 request(48):</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">02-25 16:39:25.661 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=49</div><div class="line">02-25 16:39:25.661 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=50</div><div class="line">02-25 16:39:25.661 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=51</div><div class="line">02-25 16:39:25.661 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=52</div><div class="line">...</div><div class="line">02-25 16:39:25.663 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=94</div><div class="line">02-25 16:39:25.663 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=95</div><div class="line">02-25 16:39:25.663 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=96</div><div class="line">02-25 16:39:25.663 16487-16512/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件129，观察者可接收事件数量 = 95</div><div class="line">02-25 16:39:25.663 16487-16512/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件130，观察者可接收事件数量 = 94</div><div class="line">02-25 16:39:25.663 16487-16512/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件131，观察者可接收事件数量 = 93</div><div class="line">02-25 16:39:25.663 16487-16512/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件132，观察者可接收事件数量 = 92</div><div class="line">...</div><div class="line">02-25 16:39:25.667 16487-16512/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件222，观察者可接收事件数量 = 2</div><div class="line">02-25 16:39:25.667 16487-16512/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件223，观察者可接收事件数量 = 1</div><div class="line">02-25 16:39:25.667 16487-16512/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件224，观察者可接收事件数量 = 0</div><div class="line">02-25 16:39:25.667 16487-16512/com.rengwuxian.rxjavasamples D/==Test==: 不再发送</div></pre></td></tr></table></figure>
<p>从缓存池中取出 48 个事件(49~96)，此时下游观察者接收事件 n=96，满足条件了，所以上游接着发送 96 个事件（129~224）</p>
<ul>
<li>第三次点击按钮调用 request(48):</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">02-25 16:39:55.555 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=97</div><div class="line">02-25 16:39:55.555 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=98</div><div class="line">02-25 16:39:55.555 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=99</div><div class="line">...</div><div class="line">02-25 16:39:55.557 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=142</div><div class="line">02-25 16:39:55.557 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=143</div><div class="line">02-25 16:39:55.557 16487-16487/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=144</div></pre></td></tr></table></figure>
<p>从缓存池中取出 48 个事件(97~144)，此时下游观察者接收事件 n=48.</p>
<ul>
<li>第四次点击按钮调用 request(48):</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">02-25 17:01:33.844 25959-25959/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=145</div><div class="line">02-25 17:01:33.845 25959-25959/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=146</div><div class="line">02-25 17:01:33.845 25959-25959/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=147</div><div class="line">...</div><div class="line">02-25 17:01:33.846 25959-25959/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=190</div><div class="line">02-25 17:01:33.846 25959-25959/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=191</div><div class="line">02-25 17:01:33.846 25959-25959/com.rengwuxian.rxjavasamples D/===RxJavaSample==: ==Test== onNext integer=192</div><div class="line">02-25 17:01:33.846 25959-26028/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件225，观察者可接收事件数量 = 95</div><div class="line">02-25 17:01:33.846 25959-26028/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件226，观察者可接收事件数量 = 94</div><div class="line">02-25 17:01:33.846 25959-26028/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件227，观察者可接收事件数量 = 93</div><div class="line">...</div><div class="line">02-25 17:01:33.850 25959-26028/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件318，观察者可接收事件数量 = 2</div><div class="line">02-25 17:01:33.850 25959-26028/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件319，观察者可接收事件数量 = 1</div><div class="line">02-25 17:01:33.850 25959-26028/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件320，观察者可接收事件数量 = 0</div><div class="line">02-25 17:01:33.850 25959-26028/com.rengwuxian.rxjavasamples D/==Test==: 不再发送</div></pre></td></tr></table></figure>
<p>从缓存池中取出 48 个事件(145~192)，此时下游观察者接收事件 n=96，满足条件了，所以上游接着发送 96 个事件（225~320）</p>
<p>这个情况和第二次点击按钮情况一直。</p>
<p>到这里就可以证明上面图片的正确性了。</p>
<p>到这里，避免上下游流速不匹配的方法就讲完了，下游响应式拉取，上游根据下游的能力控制发送速度。但是万一流速已经不匹配了呢？接下来就是解决这个问题的。</p>
<h2 id="BackpressureStrategy-解决流速已经不匹配的问题"><a href="#BackpressureStrategy-解决流速已经不匹配的问题" class="headerlink" title="BackpressureStrategy 解决流速已经不匹配的问题"></a>BackpressureStrategy 解决流速已经不匹配的问题</h2><p>看看源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Represents the options for applying backpressure to a source sequence.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> BackpressureStrategy &#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * OnNext events are written without any buffering or dropping.</span></div><div class="line"><span class="comment">     * Downstream has to deal with any overflow.</span></div><div class="line"><span class="comment">     * &lt;p&gt;Useful when one applies one of the custom-parameter onBackpressureXXX operators.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    MISSING,</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Signals a MissingBackpressureException in case the downstream can't keep up.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    ERROR,</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Buffers &lt;em&gt;all&lt;/em&gt; onNext values until the downstream consumes it.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    BUFFER,</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Drops the most recent onNext value if the downstream can't keep up.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    DROP,</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Keeps only the latest onNext value, overwriting any previous value if the</span></div><div class="line"><span class="comment">     * downstream can't keep up.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    LATEST</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据注释，应该就可以很好的理解这几种策略了：</p>
<ul>
<li><p>MISSING：不丢弃不缓存的策略，给出友好提示 queue is full ？</p>
</li>
<li><p>ERROR：直接抛出 MissingBackpressureException 异常。</p>
</li>
<li><p>BUFFER：缓冲所有的 onNext 事件，直到下游消费它。就是相当于无限大的缓冲池。</p>
</li>
<li><p>DROP：当下游消费不了事件时，将事件直接丢弃</p>
</li>
<li><p>LATEST：当下游消费不了事件时，只向下游发送最近的事件</p>
</li>
</ul>
<p>一个一个的展示。</p>
<h3 id="BUFFER"><a href="#BUFFER" class="headerlink" title="BUFFER"></a>BUFFER</h3><blockquote>
<p>策略：使用大小不受限制的缓存池</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Flowable.create(<span class="keyword">new</span> FlowableOnSubscribe&lt;Integer&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(FlowableEmitter&lt;Integer&gt; emitter)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">500</span>; i++) &#123;</div><div class="line">            Log.d(TAG, <span class="string">"emit "</span> + i);</div><div class="line">            emitter.onNext(i);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;, BackpressureStrategy.BUFFER) <span class="comment">//注意这里用的策略</span></div><div class="line">        .subscribeOn(Schedulers.io())</div><div class="line">        .observeOn(AndroidSchedulers.mainThread())</div><div class="line">        .subscribe(<span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</div><div class="line">                Log.d(TAG, <span class="string">"onSubscribe"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                Log.d(TAG, <span class="string">"onNext: "</span> + integer);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                Log.w(TAG, <span class="string">"onError: "</span>, t);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">                Log.d(TAG, <span class="string">"onComplete"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">02-25 17:40:47.655 18477-18477/com.rengwuxian.rxjavasamples D/==Test==: onSubscribe</div><div class="line">02-25 17:40:47.658 18477-18501/com.rengwuxian.rxjavasamples D/==Test==: emit 0</div><div class="line">02-25 17:40:47.658 18477-18501/com.rengwuxian.rxjavasamples D/==Test==: emit 1</div><div class="line">02-25 17:40:47.658 18477-18501/com.rengwuxian.rxjavasamples D/==Test==: emit 2</div><div class="line">...</div><div class="line">02-25 17:40:47.685 18477-18501/com.rengwuxian.rxjavasamples D/==Test==: emit 497</div><div class="line">02-25 17:40:47.685 18477-18501/com.rengwuxian.rxjavasamples D/==Test==: emit 498</div><div class="line">02-25 17:40:47.685 18477-18501/com.rengwuxian.rxjavasamples D/==Test==: emit 499</div></pre></td></tr></table></figure>
<p>使用无限大缓存池的 Flowable 表现出来的效果好像和 Observable 是一样的。但是单纯这种使用 Flowable 也需要注意 OOM 的情况，比如下面这个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Flowable.create(<span class="keyword">new</span> FlowableOnSubscribe&lt;Integer&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(FlowableEmitter&lt;Integer&gt; emitter)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; ; i++) &#123;</div><div class="line">            Log.d(TAG, <span class="string">"emit "</span> + i);</div><div class="line">            emitter.onNext(i);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;, BackpressureStrategy.BUFFER)</div><div class="line">        .subscribeOn(Schedulers.io())</div><div class="line">        .observeOn(AndroidSchedulers.mainThread())</div><div class="line">        .subscribe(<span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</div><div class="line">                Log.d(TAG, <span class="string">"onSubscribe"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                Log.d(TAG, <span class="string">"onNext: "</span> + integer);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                Log.w(TAG, <span class="string">"onError: "</span>, t);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">                Log.d(TAG, <span class="string">"onComplete"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>日志和内存情况：</p>
<p><img src="https://i.imgur.com/r5N7sQz.gif" alt=""></p>
<blockquote>
<p>这里可以看到，即使使用容量无限大的缓存池，对内存的压力也是特别大的，只是和使用 Observable 比较起来，这里的增长速度是比较慢的。这也看出 FLowable 相比 Observable, 在性能方面有些不足, 毕竟FLowable内部为了实现响应式拉取做了更多的操作, 性能有所丢失也是在所难免, 因此单单只是说因为 FLowable 是新兴产物就盲目的使用也是不对的, 也要具体分场景.</p>
</blockquote>
<h3 id="DROP"><a href="#DROP" class="headerlink" title="DROP"></a>DROP</h3><blockquote>
<p>策略：丢弃超过缓存区大小(128)的事件。<br>比如发送 150 个事件，仅保存 1-128 个事件，129-150 个事件丢弃</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Flowable.create(<span class="keyword">new</span> FlowableOnSubscribe&lt;Integer&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(FlowableEmitter&lt;Integer&gt; emitter)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// 发送150个事件</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i&lt; <span class="number">150</span>; i++) &#123;</div><div class="line">            Log.d(TAG, <span class="string">"发送了事件"</span> + i);</div><div class="line">            emitter.onNext(i);</div><div class="line">        &#125;</div><div class="line">        emitter.onComplete();</div><div class="line">    &#125;</div><div class="line">&#125;, BackpressureStrategy.DROP)      <span class="comment">// 设置背压模式 = BackpressureStrategy.DROP</span></div><div class="line">        .subscribeOn(Schedulers.io()) <span class="comment">// 设置被观察者在io线程中进行</span></div><div class="line">        .observeOn(AndroidSchedulers.mainThread()) <span class="comment">// 设置观察者在主线程中进行</span></div><div class="line">        .subscribe(<span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</div><div class="line">                Log.d(TAG, <span class="string">"onSubscribe"</span>);</div><div class="line">                mSubscription = s;</div><div class="line">                <span class="comment">// 通过按钮进行接收事件</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                Log.d(TAG, <span class="string">"接收到了事件"</span> + integer);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                Log.w(TAG, <span class="string">"onError: "</span>, t);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">                Log.d(TAG, <span class="string">"onComplete"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>看看日志：</p>
<p><img src="https://i.imgur.com/Sy9jncs.gif" alt=""></p>
<p>下游只能从缓存池中取出前 128 个事件，后面再去取事件时，已经取不出来了，因为后面的时间已经被丢弃了，缓存池里没有其他的事件。</p>
<h3 id="LATEST"><a href="#LATEST" class="headerlink" title="LATEST"></a>LATEST</h3><blockquote>
<p>策略：只保存最新(最后)的事件，其他的事件丢弃</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@OnClick</span>(&#123;R.id.id_btn_request, R.id.id_btn_emitter&#125;)</div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (view.getId() == R.id.id_btn_request &amp;&amp; mSubscription != <span class="keyword">null</span>) &#123;</div><div class="line">          LogUtils.d(TAG,<span class="string">"Request button clicked"</span>);</div><div class="line">          mSubscription.request(<span class="number">128</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (view.getId() == R.id.id_btn_emitter) &#123;</div><div class="line">          LogUtils.d(TAG,<span class="string">"Emitter button clicked"</span>);</div><div class="line">          Flowable.create(<span class="keyword">new</span> FlowableOnSubscribe&lt;Integer&gt;() &#123;</div><div class="line">              <span class="meta">@Override</span></div><div class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(FlowableEmitter&lt;Integer&gt; emitter)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                  <span class="comment">// 发送150个事件</span></div><div class="line">                  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">150</span>; i++) &#123;</div><div class="line">                      Log.d(TAG, <span class="string">"发送了事件"</span> + i);</div><div class="line">                      emitter.onNext(i);</div><div class="line">                  &#125;</div><div class="line">                  emitter.onComplete();</div><div class="line">              &#125;</div><div class="line">          &#125;, BackpressureStrategy.LATEST)      <span class="comment">// 设置背压模式 = BackpressureStrategy.DROP</span></div><div class="line">                  .subscribeOn(Schedulers.io()) <span class="comment">// 设置被观察者在io线程中进行</span></div><div class="line">                  .observeOn(AndroidSchedulers.mainThread()) <span class="comment">// 设置观察者在主线程中进行</span></div><div class="line">                  .subscribe(<span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</div><div class="line">                      <span class="meta">@Override</span></div><div class="line">                      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</div><div class="line">                          Log.d(TAG, <span class="string">"onSubscribe"</span>);</div><div class="line">                          mSubscription = s;</div><div class="line">                          <span class="comment">// 通过按钮进行接收事件</span></div><div class="line">                      &#125;</div><div class="line"></div><div class="line">                      <span class="meta">@Override</span></div><div class="line">                      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer integer)</span> </span>&#123;</div><div class="line">                          Log.d(TAG, <span class="string">"接收到了事件"</span> + integer);</div><div class="line">                      &#125;</div><div class="line"></div><div class="line">                      <span class="meta">@Override</span></div><div class="line">                      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                          Log.w(TAG, <span class="string">"onError: "</span>, t);</div><div class="line">                      &#125;</div><div class="line"></div><div class="line">                      <span class="meta">@Override</span></div><div class="line">                      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">                          Log.d(TAG, <span class="string">"onComplete"</span>);</div><div class="line">                      &#125;</div><div class="line">                  &#125;);</div></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/DFeA1hJ.gif" alt=""></p>
<p>下游第一次接受到了前 128 个事件， 第二次接收到了 第 150 个事件，其他事件都没有收到。</p>
<p>这里就体现出 DROP 和 LATEST 的区别了。</p>
<h3 id="MISSING"><a href="#MISSING" class="headerlink" title="MISSING"></a>MISSING</h3><blockquote>
<p>策略和 ERROR 的体现方式类似，只是给出友好提示</p>
</blockquote>
<p>这里就不贴出代码只贴出日志：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">11</span>:<span class="number">23</span>:<span class="number">20.493</span> <span class="number">13037</span>-<span class="number">13037</span>/com.rengwuxian.rxjavasamples D/==Test==: onSubscribe</div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">11</span>:<span class="number">23</span>:<span class="number">20.495</span> <span class="number">13037</span>-<span class="number">13060</span>/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件<span class="number">0</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">11</span>:<span class="number">23</span>:<span class="number">20.496</span> <span class="number">13037</span>-<span class="number">13060</span>/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件<span class="number">1</span></div><div class="line">...</div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">11</span>:<span class="number">23</span>:<span class="number">20.501</span> <span class="number">13037</span>-<span class="number">13060</span>/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件<span class="number">127</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">11</span>:<span class="number">23</span>:<span class="number">20.501</span> <span class="number">13037</span>-<span class="number">13060</span>/com.rengwuxian.rxjavasamples D/==Test==: 发送了事件<span class="number">128</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">11</span>:<span class="number">23</span>:<span class="number">20.521</span> <span class="number">13037</span>-<span class="number">13037</span>/com.rengwuxian.rxjavasamples W/==Test==: onError: </div><div class="line">                                                                        io.reactivex.exceptions.MissingBackpressureException: Queue is full?!</div><div class="line">                                                                            at io.reactivex.internal.operators.flowable.FlowableObserveOn$BaseObserveOnSubscriber.onNext(FlowableObserveOn.java:<span class="number">114</span>)</div><div class="line">                                                                            at io.reactivex.internal.operators.flowable.FlowableSubscribeOn$SubscribeOnSubscriber.onNext(FlowableSubscribeOn.java:<span class="number">97</span>)</div><div class="line">                                                                            at io.reactivex.internal.operators.flowable.FlowableCreate$MissingEmitter.onNext(FlowableCreate.java:<span class="number">338</span>)</div><div class="line">                                                                            at com.rengwuxian.rxjavasamples.Test$<span class="number">2</span>.subscribe(Test.java:<span class="number">52</span>)</div><div class="line">                                                                            at io.reactivex.internal.operators.flowable.FlowableCreate.subscribeActual(FlowableCreate.java:<span class="number">72</span>)</div><div class="line">                                                                            at io.reactivex.Flowable.subscribe(Flowable.java:<span class="number">12970</span>)</div><div class="line">                                                                            at io.reactivex.Flowable.subscribe(Flowable.java:<span class="number">12917</span>)</div><div class="line">                                                                            at io.reactivex.internal.operators.flowable.FlowableSubscribeOn$SubscribeOnSubscriber.run(FlowableSubscribeOn.java:<span class="number">82</span>)</div><div class="line">                                                                            at io.reactivex.internal.schedulers.ScheduledRunnable.run(ScheduledRunnable.java:<span class="number">59</span>)</div><div class="line">                                                                            at io.reactivex.internal.schedulers.ScheduledRunnable.call(ScheduledRunnable.java:<span class="number">51</span>)</div><div class="line">                                                                            at java.util.concurrent.FutureTask.run(FutureTask.java:<span class="number">237</span>)</div><div class="line">                                                                            at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:<span class="number">272</span>)</div><div class="line">                                                                            at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1133</span>)</div><div class="line">                                                                            at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">607</span>)</div><div class="line">                                                                            at java.lang.Thread.run(Thread.java:<span class="number">760</span>)</div></pre></td></tr></table></figure>
<h2 id="当-Flowable-不是我们自己创建时"><a href="#当-Flowable-不是我们自己创建时" class="headerlink" title="当 Flowable 不是我们自己创建时"></a>当 Flowable 不是我们自己创建时</h2><p>上面例子中红的 Flowable 都是我们自己手动创建的，但是存在部分情况 Flowable 不是右我们自己创建的，比如使用 interval 操作符创建 Flowable ， 那么这种情况下当流速不匹配时如何选择背压策略呢？</p>
<blockquote>
<p>intetval 操作符：<img src="http://reactivex.io/documentation/operators/images/interval.c.png" alt=""><br>Interval运算符返回一个 Observable / Flowable，它发出一个升序整数(Long 类型)的无限序列，并在发射之间选择一个固定的时间间隔，默认运行在一个新的线程上。</p>
</blockquote>
<p>看代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Flowable.interval(<span class="number">1</span>, TimeUnit.MILLISECONDS) <span class="comment">// 1秒发送1000个事件</span></div><div class="line">                .observeOn(Schedulers.newThread()) <span class="comment">// 观察者同样工作在一个新开线程中</span></div><div class="line">                .subscribe(<span class="keyword">new</span> Subscriber&lt;Long&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</div><div class="line">                        Log.d(TAG, <span class="string">"onSubscribe"</span>);</div><div class="line">                        mSubscription = s;</div><div class="line">                        s.request(Long.MAX_VALUE); <span class="comment">//默认可以接收Long.MAX_VALUE个事件</span></div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Long aLong)</span> </span>&#123;</div><div class="line">                        Log.d(TAG, <span class="string">"onNext: "</span> + aLong);</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            Thread.sleep(<span class="number">1000</span>);</div><div class="line"></div><div class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                            e.printStackTrace();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                        Log.w(TAG, <span class="string">"onError: "</span>, t);</div><div class="line">                    &#125;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">                        Log.d(TAG, <span class="string">"onComplete"</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure>
<p>日志：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">11</span>:<span class="number">59</span>:<span class="number">29.497</span> <span class="number">3959</span>-<span class="number">3959</span>/com.rengwuxian.rxjavasamples D/==Test==: onSubscribe</div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">11</span>:<span class="number">59</span>:<span class="number">29.501</span> <span class="number">3959</span>-<span class="number">4126</span>/com.rengwuxian.rxjavasamples D/==Test==: onNext: <span class="number">0</span></div><div class="line"><span class="number">02</span>-<span class="number">26</span> <span class="number">11</span>:<span class="number">59</span>:<span class="number">30.508</span> <span class="number">3959</span>-<span class="number">4126</span>/com.rengwuxian.rxjavasamples W/==Test==: onError: </div><div class="line">                                                                      io.reactivex.exceptions.MissingBackpressureException: Can<span class="string">'t deliver value 128 due to lack of requests</span></div><div class="line"><span class="string">                                                                          at io.reactivex.internal.operators.flowable.FlowableInterval$IntervalSubscriber.run(FlowableInterval.java:87)</span></div><div class="line"><span class="string">                                                                          at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:428)</span></div><div class="line"><span class="string">                                                                          at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:278)</span></div><div class="line"><span class="string">                                                                          at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:273)</span></div><div class="line"><span class="string">                                                                          at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1133)</span></div><div class="line"><span class="string">                                                                          at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:607)</span></div><div class="line"><span class="string">                                                                          at java.lang.Thread.run(Thread.java:760)</span></div></pre></td></tr></table></figure>
<p>这是没有采取背压策略，缓冲区马上被充满，然后抛出 MissingBackpressureException 。</p>
<p>如何解决？</p>
<p>上面抛出的异常是因为 RxJava2.0 在内部已经封装好了策略，默认使用的是 ERROR 策略，还有其他的三种：</p>
<ul>
<li>onBackpressureBuffer()</li>
<li>onBackpressureDrop()</li>
<li>onBackpressureLatest()</li>
</ul>
<p>使用 DROP 策略看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Flowable.interval(<span class="number">1</span>, TimeUnit.MILLISECONDS) <span class="comment">// 1秒发送1000个事件</span></div><div class="line">        .onBackpressureDrop()<span class="comment">// 采用 DROP 策略</span></div><div class="line">        .observeOn(Schedulers.newThread()) <span class="comment">// 观察者同样工作在一个新开线程中</span></div><div class="line">        .subscribe(<span class="keyword">new</span> Subscriber&lt;Long&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</div><div class="line">                Log.d(TAG, <span class="string">"onSubscribe"</span>);</div><div class="line">                mSubscription = s;</div><div class="line">                s.request(Long.MAX_VALUE); <span class="comment">//默认可以接收Long.MAX_VALUE个事件</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Long aLong)</span> </span>&#123;</div><div class="line">                Log.d(TAG, <span class="string">"onNext: "</span> + aLong);</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Thread.sleep(<span class="number">100</span>);</div><div class="line"></div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">                Log.w(TAG, <span class="string">"onError: "</span>, t);</div><div class="line">            &#125;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">                Log.d(TAG, <span class="string">"onComplete"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>日志：</p>
<p><img src="https://i.imgur.com/5DNSzwe.gif" alt=""></p>
<p>注意 127 之后的序列，符合 DROP 的策略模式。</p>
<p>其他两种就不做演示了。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><img src="https://upload-images.jianshu.io/upload_images/944365-1be234a3c566c7bc.png" alt=""></p>
</font>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/RxJava/" rel="tag"># RxJava</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/02/24/适配器模式/" rel="next" title="一口一口啃完Java中的24种设计模式---适配器模式">
                <i class="fa fa-chevron-left"></i> 一口一口啃完Java中的24种设计模式---适配器模式
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/03/10/JavaObjectConstruct/" rel="prev" title="Java 基础夯实 --- Java 对象的创建">
                Java 基础夯实 --- Java 对象的创建 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>

  <div class="theme-info">
   <div class="powered-by"></div>
   <span class="post-count">共88.7k字</span>
  </div>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar_z.jpg"
                alt="BIGZ" />
            
              <p class="site-author-name" itemprop="name">BIGZ</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/zengfanyu" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i></a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:zengfanyunb@gmail.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i></a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#宏观上解决流速不匹配的问题"><span class="nav-number">1.</span> <span class="nav-text">宏观上解决流速不匹配的问题</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#背压策略"><span class="nav-number">2.</span> <span class="nav-text">背压策略</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定义"><span class="nav-number">2.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#作用"><span class="nav-number">2.2.</span> <span class="nav-text">作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解决的问题"><span class="nav-number">2.3.</span> <span class="nav-text">解决的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#原理"><span class="nav-number">2.4.</span> <span class="nav-text">原理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#背压策略的实现：Flowable"><span class="nav-number">3.</span> <span class="nav-text">背压策略的实现：Flowable</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Flowable-基本使用"><span class="nav-number">3.1.</span> <span class="nav-text">Flowable 基本使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Subscription-request-控制观察者的接收速度"><span class="nav-number">3.2.</span> <span class="nav-text">Subscription.request 控制观察者的接收速度</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FlowableEmitter-requested-控制被观察者发送事件的速度"><span class="nav-number">3.3.</span> <span class="nav-text">FlowableEmitter.requested 控制被观察者发送事件的速度</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#同步订阅情况下"><span class="nav-number">3.3.1.</span> <span class="nav-text">同步订阅情况下</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异步订阅情况下"><span class="nav-number">3.3.2.</span> <span class="nav-text">异步订阅情况下</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BackpressureStrategy-解决流速已经不匹配的问题"><span class="nav-number">3.4.</span> <span class="nav-text">BackpressureStrategy 解决流速已经不匹配的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BUFFER"><span class="nav-number">3.4.1.</span> <span class="nav-text">BUFFER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DROP"><span class="nav-number">3.4.2.</span> <span class="nav-text">DROP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LATEST"><span class="nav-number">3.4.3.</span> <span class="nav-text">LATEST</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MISSING"><span class="nav-number">3.4.4.</span> <span class="nav-text">MISSING</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#当-Flowable-不是我们自己创建时"><span class="nav-number">3.5.</span> <span class="nav-text">当 Flowable 不是我们自己创建时</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">BIGZ</span>

  
</div>








  <div class="footer-custom">Every little makes a mickel</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












.gt-container a{border-bottom: none;}
  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("YbNmOD8tolbrONHtHJyWdEq7-gzGzoHsz", "PTVGwiHfE44yKqqU8xYjhJOJ");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
  

  

  

  

</body>
</html>
